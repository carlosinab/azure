name: Blue-Green Deployment

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (v1, v2, v3)'
        required: true
        default: 'v1'
        type: choice
        options: [v1, v2, v3]
      target:
        description: 'Deploy to'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production, both]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare App Package
        run: |
          mkdir -p deploy
          if [ "${{ github.event.inputs.version }}" == "v1" ]; then
            cp app/index.html deploy/index.html
          elif [ "${{ github.event.inputs.version }}" == "v2" ]; then
            cp app/index-v2.html deploy/index.html
          else
            cp app/index-v3.html deploy/index.html  # Create this file
          fi
          cp app/web.config deploy/web.config
          cd deploy && zip -r ../app.zip . && cd ..

      - name: Deploy to Staging
        if: github.event.inputs.target == 'staging' || github.event.inputs.target == 'both'
        uses: azure/webapps-deploy@v2
        with:
          app-name: app-azurelab-sysres
          slot-name: staging
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_STAGING }}
          package: app.zip

      - name: Deploy to Production
        if: github.event.inputs.target == 'production' || github.event.inputs.target == 'both'
        uses: azure/webapps-deploy@v2
        with:
          app-name: app-azurelab-sysres
          slot-name: production
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_PRODUCTION }}
          package: app.zip

      - name: Show URLs
        run: |
          echo "Staging: https://app-azurelab-sysres-staging.azurewebsites.net"
          echo "Production: https://app-azurelab-sysres.azurewebsites.net"